<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Condemnation Form - Annexure V</title>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
    
    body {
        font-family: 'Arial', sans-serif;
        background-color: #f4f4f9;
        margin: 0;
        padding: 20px;
    }
    .form-container {
        max-width: 800px;
        margin: 0 auto;
        background-color: #fff;
        border: 2px solid #333;
        border-radius: 10px;
        padding: 20px;
        position: relative;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    h2, h3 {
        text-align: center;
        color: #333;
    }
    h2 {
        margin-bottom: 5px;
        font-size: 24px;
    }
    h3 {
        margin-top: 0;
        font-size: 18px;
        color: #555;
    }
    .table-container {
        overflow-x: auto;
        margin: 20px 0;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        min-width: 1090px;
    }
    th, td {
        border: 1px solid #ccc;
        padding: 10px 15px;
        text-align: left;
        font-size: 16px;
    }
    th:nth-child(1), td:nth-child(1) { min-width: 25px; }
    th:nth-child(2), td:nth-child(2) { min-width: 140px; }
    th:nth-child(3), td:nth-child(3),
    th:nth-child(4), td:nth-child(4),
    th:nth-child(5), td:nth-child(5),
    th:nth-child(6), td:nth-child(6),
    th:nth-child(7), td:nth-child(7) { min-width: 75px; }
    th:nth-child(8), td:nth-child(8),
    th:nth-child(9), td:nth-child(9),
    th:nth-child(10), td:nth-child(10),
    th:nth-child(11), td:nth-child(11),
    th:nth-child(12), td:nth-child(12) { min-width: 110px; }
    th {
        background-color: #fff;
        font-weight: bold;
        color: #333;
    }
    td {
        background-color: #fff;
    }
    textarea {
        width: 100%;
        border: none;
        background: transparent;
        font-size: 16px;
        padding: 0;
        text-align: left;
        white-space: pre-wrap;
        resize: none;
        overflow: hidden;
        line-height: 1.2;
        min-height: 20px;
    }
    textarea:focus {
        outline: none;
    }
    input[type="date"] {
        width: 100%;
        border: none;
        background: transparent;
        font-size: 16px;
        padding: 0;
        text-align: left;
    }
    input[type="date"]:focus {
        outline: none;
    }
    .section-title {
        font-weight: bold;
        font-size: 16px;
        margin-top: 20px;
        color: #333;
        text-align: center;
        margin-bottom: 15px;
    }
    .signature-section {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
    }
    .signature-section div {
        width: 45%;
    }
    .signature-line {
        width: 200px;
        border-bottom: 1px solid #333;
        display: inline-block;
        vertical-align: baseline;
        position: relative;
        margin-left: 5px;
        margin-top: 5px;
    }
    .signature-line {
        display: flex;
        align-items: center;
        position: relative;
    }
    #signatureArea {
        width: 200px;
    }
    #designationInput {
        flex-grow: 1;
        margin-right: 5px;
    }
    .signature-line input {
        width: 100%;
        border: none;
        background: transparent;
        font-size: 16px;
        padding: 0;
        position: absolute;
        top: -15px;
        left: 0;
        color: #333;
        text-align: left;
    }
    .signature-line input:focus {
        outline: none;
        color: #333;
    }
    .action-btn {
        padding: 4px 8px;
        font-size: 12px;
        margin-left: 5px;
        background-color: #4CAF50; /* Green for Approve */
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
    }
    #rejectBtn {
        background-color: #f44336; /* Red for Reject */
    }
    .action-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    #signatureArea img {
        max-width: 100px;
        max-height: 50px;
        vertical-align: middle;
    }
    .committee-list {
        margin-left: 0;
        font-size: 14px;
        line-height: 1.6;
    }
    .committee-list p {
        margin: 5px 0;
    }
    .committee-members-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
    }
    .committee-members-row p {
        flex: 1;
        margin-right: 20px;
    }
    .committee-members-row p:last-child {
        margin-right: 0;
    }
    .submit-button {
        position: absolute;
        bottom: 20px;
        right: 20px;
        padding: 10px 20px;
        background-color: #007bff;
        color: #fff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
    }
    .submit-button:hover {
        background-color: #0056b3;
    }
    @media (max-width: 1280px) {
        .table-container {
            overflow-x: auto;
        }
        th, td {
            font-size: 14px;
            padding: 10px 10px;
        }
        th:nth-child(1), td:nth-child(1) { min-width: 25px; }
        th:nth-child(2), td:nth-child(2) { min-width: 140px; }
        th:nth-child(3), td:nth-child(3),
        th:nth-child(4), td:nth-child(4),
        th:nth-child(5), td:nth-child(5),
        th:nth-child(6), td:nth-child(6),
        th:nth-child(7), td:nth-child(7) { min-width: 75px; }
        th:nth-child(8), td:nth-child(8),
        th:nth-child(9), td:nth-child(9),
        th:nth-child(10), td:nth-child(10),
        th:nth-child(11), td:nth-child(11),
        th:nth-child(12), td:nth-child(12) { min-width: 110px; }
    }
    @media (max-width: 768px) {
        .form-container {
            padding: 15px;
        }
        th, td {
            font-size: 12px;
            padding: 10px 5px;
        }
        th:nth-child(1), td:nth-child(1) { min-width: 20px; }
        th:nth-child(2), td:nth-child(2) { min-width: 100px; }
        th:nth-child(3), td:nth-child(3),
        th:nth-child(4), td:nth-child(4),
        th:nth-child(5), td:nth-child(5),
        th:nth-child(6), td:nth-child(6),
        th:nth-child(7), td:nth-child(7) { min-width: 60px; }
        th:nth-child(8), td:nth-child(8),
        th:nth-child(9), td:nth-child(9),
        th:nth-child(10), td:nth-child(10),
        th:nth-child(11), td:nth-child(11),
        th:nth-child(12), td:nth-child(12) { min-width: 80px; }
        .signature-section {
            flex-direction: column;
        }
        .signature-section div {
            width: 100%;
            margin-bottom: 20px;
        }
        .committee-members-row {
            flex-direction: column;
        }
        .committee-members-row p {
            margin-right: 0;
            margin-bottom: 10px;
        }
        .submit-button {
            position: static;
            margin-top: 20px;
            width: 100%;
        }
    }
    
    .export-button {
    position: absolute;
    top: 20px;    /* Distance from the top of the container */
    right: 20px;  /* Distance from the right of the container */
    padding: 10px 20px;
    background-color: #28a745; /* Green to distinguish it */
    color: #fff;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
}
.export-button:hover {
    background-color: #218838;
}
    
</style>
</head>
<body>
   <div class="form-container">
       <button class="export-button" id="exportPdfBtn">Export as PDF</button>
    <h2>Annexure V</h2>
    <h3>Proforma</h3>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Sr. No.</th>
                    <th>Description of Stores/Items</th>
                    <th>Quantity/Weight</th>
                    <th>Book/Original Value</th>
                    <th>Date of Purchase</th>
                    <th>Date/Month of item becoming Unserviceable</th>
                    <th>Period of use</th>
                    <th>Present condition of service (In service/out of service)</th>
                    <th>Whether effort have been taken to repair. If so thereof (also specify cost incurring)</th>
                    <th>Location where the items are stored for condemnation</th>
                    <th>Reason for Condemnation</th>
                    <th>Remarks</th>
                </tr>
            </thead>
            <tbody>
                <tr data-item-id="">
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><input type="date" id="purchaseDate1"><input type="hidden" class="item-id"></td>
                    <td><input type="date"></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea id="reason1"></textarea></td>
                    <td><textarea></textarea></td>
                </tr>
                <tr data-item-id="">
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><input type="date" id="purchaseDate2"><input type="hidden" class="item-id"></td>
                    <td><input type="date"></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea id="reason2"></textarea></td>
                    <td><textarea></textarea></td>
                </tr>
                <tr data-item-id="">
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><input type="date" id="purchaseDate3"><input type="hidden" class="item-id"></td>
                    <td><input type="date"></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea id="reason3"></textarea></td>
                    <td><textarea></textarea></td>
                </tr>
                <tr data-item-id="">
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><input type="date" id="purchaseDate4"><input type="hidden" class="item-id"></td>
                    <td><input type="date"></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea id="reason4"></textarea></td>
                    <td><textarea></textarea></td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="signature-section">
        <div>
            <div class="section-title">Prepared by:</div>
            <p>Name: <span class="signature-line"><input type="text"></span></p>
            <p>Designation: <span class="signature-line"><input type="text"></span></p>
        </div>
        <div>
            <div class="section-title">Reviewed by:</div>
            <p>Name: <span class="signature-line"><input type="text"></span></p>
            <p>Designation: <span class="signature-line"><input type="text"></span></p>
        </div>
    </div>

    <div class="section-title">Condemnation Committee Members</div>
    <div class="committee-list">
        <div class="committee-members-row">
            <p>1. Name: Dr. Krupashankara M.S (Chairman)<br>Designation: Principal</p>
            <p>2. Name: <span class="signature-line"><input type="text"></span> (Member)<br>Designation: <span class="signature-line"><input type="text"></span></p>
            <p>3. Name: Shri. Sunil Rauf (Member)<br>
                <span id="designationLabel">Designation:</span> 
                <span class="signature-line" id="signatureArea">
                    <input type="text" id="designationInput">
                    <button type="button" id="approveBtn" class="action-btn">Approve</button>
                    <button type="button" id="rejectBtn" class="action-btn">Reject</button>
                </span>
            </p>
        </div>
        <p>4. Name: <span class="signature-line"><input type="text"></span> (Member)</p>
        <p>5. Name: <span class="signature-line"><input type="text"></span> (Invited Member)</p>
    </div>

    <button class="submit-button">Submit</button>
    </div>
    
  <script>
// Auto-resize textareas (runs immediately)
document.querySelectorAll('textarea').forEach(textarea => {
    textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = `${this.scrollHeight}px`;
    });
    textarea.dispatchEvent(new Event('input'));
});

// Form initialization and submission
window.onload = function() {
    const urlParams = new URLSearchParams(window.location.search);
    const requestId = urlParams.get('requestId');
    const rows = document.querySelectorAll('tbody tr');

    if (requestId) {
        loadExistingForm(requestId);
    } else {
        loadPrefillData();
    }

    const submitButton = document.querySelector('.submit-button');
    submitButton.addEventListener('click', handleFormSubmission);

    const approveBtn = document.getElementById('approveBtn');
    const rejectBtn = document.getElementById('rejectBtn');
    const signatureArea = document.getElementById('signatureArea');

    function applySignature(status) {
        const signature = localStorage.getItem('signature');
        if (signature) {
            signatureArea.innerHTML = `<img src="${signature}">`;
            document.querySelectorAll('textarea, input, button').forEach(field => field.disabled = true);
            const urlParams = new URLSearchParams(window.location.search);
            const requestId = urlParams.get('requestId');
            if (requestId) {
                const forms = JSON.parse(localStorage.getItem('condemnationForms') || '[]');
                const formIndex = forms.findIndex(f => f.requestId === requestId);
                if (formIndex > -1) {
                    forms[formIndex].status = status;
                    localStorage.setItem('condemnationForms', JSON.stringify(forms));
                }
            }
        } else {
            alert('Please upload a signature in Settings first!');
        }
    }

    approveBtn.addEventListener('click', () => applySignature('Approved'));
    rejectBtn.addEventListener('click', () => applySignature('Rejected'));
};
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('exportPdfBtn').addEventListener('click', function() {
        // Store original button and input states to hide them during export
        const buttons = document.querySelectorAll('button, input[type="button"]');
        const originalDisplay = [];
        buttons.forEach(btn => {
            originalDisplay.push(btn.style.display);
            btn.style.display = 'none'; // Hide buttons
        });

        const element = document.querySelector('.form-container');
        const opt = {
            margin: [0.5, 0.5, 0.5, 0.5], // Top, right, bottom, left margins in inches
            filename: `Condemnation_Form_${new Date().toISOString().split('T')[0]}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { 
                scale: 2, // Higher resolution for better quality
                useCORS: true,
                windowWidth: 1200 // Ensure full form width is captured
            },
            jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
        };

        // Store original styles to restore later
        const originalWidth = element.style.width;
        const originalPadding = element.style.padding;
        const originalMargin = element.style.margin;
        const originalMarginLeft = element.style.marginLeft;
        const originalMarginRight = element.style.marginRight;
        const originalOverflow = element.style.overflow;

        // Adjust layout for PDF
        element.style.width = '800px'; // Match the form’s max-width
        element.style.padding = '20px';
        element.style.margin = '0'; // Remove auto centering
        element.style.marginLeft = '-120px'; // Shift left by 120px (50px + 50px + 20px extra)
        element.style.marginRight = '120px'; // Balance the right side
        element.style.overflow = 'visible'; // Prevent clipping

        const table = element.querySelector('table');
        const originalTableWidth = table.style.width;
        const originalTableMinWidth = table.style.minWidth;
        table.style.width = '100%'; // Fit table to container
        table.style.minWidth = '0'; // Prevent table from forcing a wider width

        // Debug: Log the current styles to confirm changes
        console.log('Current marginLeft:', element.style.marginLeft);
        console.log('Current marginRight:', element.style.marginRight);

        // Generate the PDF
        html2pdf().set(opt).from(element).save().then(() => {
            // Restore original styles and button visibility
            element.style.width = originalWidth;
            element.style.padding = originalPadding;
            element.style.margin = originalMargin;
            element.style.marginLeft = originalMarginLeft;
            element.style.marginRight = originalMarginRight;
            element.style.overflow = originalOverflow;
            table.style.width = originalTableWidth;
            table.style.minWidth = originalTableMinWidth;
            buttons.forEach((btn, index) => {
                btn.style.display = originalDisplay[index];
            });
        }).catch(err => {
            console.error('PDF generation failed:', err);
            // Restore styles even if there’s an error
            element.style.width = originalWidth;
            element.style.padding = originalPadding;
            element.style.margin = originalMargin;
            element.style.marginLeft = originalMarginLeft;
            element.style.marginRight = originalMarginRight;
            element.style.overflow = originalOverflow;
            table.style.width = originalTableWidth;
            table.style.minWidth = originalTableMinWidth;
            buttons.forEach((btn, index) => {
                btn.style.display = originalDisplay[index];
            });
        });
    });
});
function loadExistingForm(requestId) {
    const forms = JSON.parse(localStorage.getItem('condemnationForms') || '[]');
    const formData = forms.find(f => f.requestId === requestId);

    if (formData) {
        formData.items.forEach((item, index) => {
            const row = document.querySelectorAll('tbody tr')[index];
            if (row) {
                row.dataset.itemId = item.itemId || '';
                row.querySelector('td:nth-child(1) textarea').value = item.srNo || index + 1;
                row.querySelector('td:nth-child(2) textarea').value = item.description || item.productName || '';
                row.querySelector('td:nth-child(3) textarea').value = item.quantity || '';
                row.querySelector('td:nth-child(4) textarea').value = item.bookValue || '';
                row.querySelector('td:nth-child(5) input[type="date"]').value = item.purchaseDate || '';
                row.querySelector('td:nth-child(6) input[type="date"]').value = item.unserviceableDate || '';
                row.querySelector('td:nth-child(7) textarea').value = item.periodOfUse || '';
                row.querySelector('td:nth-child(8) textarea').value = item.condition || '';
                row.querySelector('td:nth-child(9) textarea').value = item.repairEfforts || '';
                row.querySelector('td:nth-child(10) textarea').value = item.location || '';
                row.querySelector('td:nth-child(11) textarea').value = item.reason || '';
                row.querySelector('td:nth-child(12) textarea').value = item.remarks || '';
            }
        });
        document.querySelector('.submit-button').textContent = 'Update and Submit';
    }
}

function loadPrefillData() {
    const prefillData = JSON.parse(localStorage.getItem('condemnationFormData') || '[]');
    prefillData.slice(0, 4).forEach((item, index) => {
        const row = document.querySelectorAll('tbody tr')[index];
        if (row) {
            row.dataset.itemId = item.id;
            row.querySelector('td:nth-child(1) textarea').value = index + 1;
            row.querySelector('td:nth-child(2) textarea').value = item.productName;
            row.querySelector('td:nth-child(5) input[type="date"]').value = item.purchaseDate;
            row.querySelector('td:nth-child(11) textarea').value = item.reason;
        }
    });
}

function handleFormSubmission() {
    const urlParams = new URLSearchParams(window.location.search);
    const requestId = urlParams.get('requestId');
    
    if (requestId) {
        updateForm(requestId);
    } else {
        submitNewForm();
    }
    
    // Show success message
    alert('Form submitted successfully!');
    
    // Notify the main window and close this window
    if (window.opener && !window.opener.closed) {
        window.opener.postMessage({ type: 'formSubmitted', success: true }, '*');
    }
    window.close();
}

function submitNewForm() {
    const formData = {
        requestId: `REQ-${Date.now()}`,
        timestamp: new Date().toISOString(),
        items: [],
        status: 'Pending'
    };

    document.querySelectorAll('tbody tr').forEach((row, index) => {
        const itemData = {
            itemId: row.dataset.itemId || '',
            srNo: row.querySelector('td:nth-child(1) textarea').value || (index + 1),
            description: row.querySelector('td:nth-child(2) textarea').value || '',
            quantity: row.querySelector('td:nth-child(3) textarea').value || '',
            bookValue: row.querySelector('td:nth-child(4) textarea').value || '',
            purchaseDate: row.querySelector('td:nth-child(5) input[type="date"]').value || '',
            unserviceableDate: row.querySelector('td:nth-child(6) input[type="date"]').value || '',
            periodOfUse: row.querySelector('td:nth-child(7) textarea').value || '',
            condition: row.querySelector('td:nth-child(8) textarea').value || '',
            repairEfforts: row.querySelector('td:nth-child(9) textarea').value || '',
            location: row.querySelector('td:nth-child(10) textarea').value || '',
            reason: row.querySelector('td:nth-child(11) textarea').value || '',
            remarks: row.querySelector('td:nth-child(12) textarea').value || ''
        };
        if (itemData.description || itemData.reason) {
            formData.items.push(itemData);
        }
    });

    if (formData.items.length === 0) {
        alert('Please fill in at least one item.');
        return;
    }

    const existingForms = JSON.parse(localStorage.getItem('condemnationForms') || '[]');
    localStorage.setItem('condemnationForms', JSON.stringify([...existingForms, formData]));
    localStorage.removeItem('condemnationFormData');
    alert('Form submitted successfully!');
}

function updateForm(requestId) {
    const forms = JSON.parse(localStorage.getItem('condemnationForms') || '[]');
    const formIndex = forms.findIndex(f => f.requestId === requestId);

    if (formIndex > -1) {
        const updatedForm = forms[formIndex];
        updatedForm.items = [];
        document.querySelectorAll('tbody tr').forEach((row, index) => {
            const itemData = {
                itemId: row.dataset.itemId || '',
                srNo: row.querySelector('td:nth-child(1) textarea').value || (index + 1),
                description: row.querySelector('td:nth-child(2) textarea').value || '',
                quantity: row.querySelector('td:nth-child(3) textarea').value || '',
                bookValue: row.querySelector('td:nth-child(4) textarea').value || '',
                purchaseDate: row.querySelector('td:nth-child(5) input[type="date"]').value || '',
                unserviceableDate: row.querySelector('td:nth-child(6) input[type="date"]').value || '',
                periodOfUse: row.querySelector('td:nth-child(7) textarea').value || '',
                condition: row.querySelector('td:nth-child(8) textarea').value || '',
                repairEfforts: row.querySelector('td:nth-child(9) textarea').value || '',
                location: row.querySelector('td:nth-child(10) textarea').value || '',
                reason: row.querySelector('td:nth-child(11) textarea').value || '',
                remarks: row.querySelector('td:nth-child(12) textarea').value || ''
            };
            if (itemData.description || itemData.reason) {
                updatedForm.items.push(itemData);
            }
        });
        forms[formIndex] = updatedForm;
        localStorage.setItem('condemnationForms', JSON.stringify(forms));
        alert('Form updated successfully!');
    }
}
</script>
</body>
</html>



